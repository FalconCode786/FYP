{% extends 'base.html' %}

{% block title %}Apply for Metering - Al Muslim Engineers{% endblock %}

{% block content %}
<section class="form-section">
    <div class="form-container">
        <div class="form-card form-card-large">
            <div class="form-header">
                <div class="form-icon">
                    <i class="fas fa-solar-panel"></i>
                </div>
                <h1>Apply for Metering</h1>
                <p>Submit your net or gross metering application</p>
            </div>
            
            <div class="metering-info">
                <div class="info-card">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Important Information:</strong>
                        <ul>
                            <li>Net Metering: Available for systems <strong>5kW and above</strong></li>
                            <li>Gross Metering: Available for systems <strong>1kW to 50kW</strong></li>
                            <li>Service Area: <strong>Rawalpindi Only</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <form method="POST" action="{{ url_for('apply_metering') }}" enctype="multipart/form-data">
                <div class="form-section-title">
                    <i class="fas fa-list-alt"></i> Application Details
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="application_type">Application Type <span class="required">*</span></label>
                        <select id="application_type" name="application_type" required onchange="updateCapacityLimits()">
                            <option value="">Select Type</option>
                            <option value="net">Net Metering (Export to Grid)</option>
                            <option value="gross">Gross Metering (Sell All to Grid)</option>
                        </select>
                        <small class="form-hint" id="typeHint"></small>
                    </div>
                    
                    <div class="form-group">
                        <label for="system_capacity">System Capacity (kW) <span class="required">*</span></label>
                        <input type="number" id="system_capacity" name="system_capacity" 
                               min="1" max="50" step="0.1" required
                               placeholder="Enter capacity (1-50 kW)">
                        <small class="form-hint" id="capacityHint">Range: 1kW - 50kW</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="consumption_units">Monthly Consumption (Units)</label>
                        <input type="number" id="consumption_units" name="consumption_units" 
                               placeholder="Average monthly units">
                        <small class="form-hint">Helps us recommend optimal system size</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="property_type">Property Type <span class="required">*</span></label>
                        <select id="property_type" name="property_type" required>
                            <option value="">Select Type</option>
                            <option value="residential">Residential</option>
                            <option value="commercial">Commercial</option>
                            <option value="industrial">Industrial</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section-title">
                    <i class="fas fa-map-marker-alt"></i> Property Location
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="property_address">Property Address <span class="required">*</span></label>
                        <textarea id="property_address" name="property_address" rows="3" required
                                  placeholder="Enter complete address in Rawalpindi"></textarea>
                        <small class="form-hint">Please provide detailed address including sector/area</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="ownership_type">Ownership Status <span class="required">*</span></label>
                        <select id="ownership_type" name="ownership_type" required onchange="toggleNocField()">
                            <option value="owner">Property Owner</option>
                            <option value="tenant">Tenant</option>
                        </select>
                        <small class="form-hint">If tenant, a NOC from the landowner is required</small>
                    </div>
                </div>
                
                <div class="form-section-title">
                    <i class="fas fa-id-card"></i> CNIC (Computerized National Identity Card) <span class="required">*</span>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="cnic_front">CNIC Front Side <span class="required">*</span></label>
                        <div class="file-upload-wrapper">
                            <label class="file-upload-label" for="cnic_front" id="cnic_front_label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Click to upload CNIC front</span>
                                <small>JPG, PNG, PDF (Max 5MB)</small>
                            </label>
                            <input type="file" id="cnic_front" name="cnic_front" accept=".jpg,.jpeg,.png,.pdf,.webp" required onchange="updateFileLabel(this, 'cnic_front_label')">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cnic_back">CNIC Back Side <span class="required">*</span></label>
                        <div class="file-upload-wrapper">
                            <label class="file-upload-label" for="cnic_back" id="cnic_back_label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Click to upload CNIC back</span>
                                <small>JPG, PNG, PDF (Max 5MB)</small>
                            </label>
                            <input type="file" id="cnic_back" name="cnic_back" accept=".jpg,.jpeg,.png,.pdf,.webp" required onchange="updateFileLabel(this, 'cnic_back_label')">
                        </div>
                    </div>
                </div>
                
                <div class="form-section-title">
                    <i class="fas fa-file-invoice"></i> Electric Bill of House <span class="required">*</span>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="electric_bill_front">Electric Bill - Front <span class="required">*</span></label>
                        <div class="file-upload-wrapper">
                            <label class="file-upload-label" for="electric_bill_front" id="electric_bill_front_label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Click to upload bill front</span>
                                <small>JPG, PNG, PDF (Max 5MB)</small>
                            </label>
                            <input type="file" id="electric_bill_front" name="electric_bill_front" accept=".jpg,.jpeg,.png,.pdf,.webp" required onchange="updateFileLabel(this, 'electric_bill_front_label')">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="electric_bill_back">Electric Bill - Back <span class="required">*</span></label>
                        <div class="file-upload-wrapper">
                            <label class="file-upload-label" for="electric_bill_back" id="electric_bill_back_label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Click to upload bill back</span>
                                <small>JPG, PNG, PDF (Max 5MB)</small>
                            </label>
                            <input type="file" id="electric_bill_back" name="electric_bill_back" accept=".jpg,.jpeg,.png,.pdf,.webp" required onchange="updateFileLabel(this, 'electric_bill_back_label')">
                        </div>
                    </div>
                </div>
                
                <div class="form-section-title">
                    <i class="fas fa-home"></i> Property Documents <span class="required">*</span>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="land_ownership_doc">Land Ownership Document <span class="required">*</span></label>
                        <div class="file-upload-wrapper">
                            <label class="file-upload-label" for="land_ownership_doc" id="land_ownership_doc_label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Click to upload ownership doc</span>
                                <small>JPG, PNG, PDF (Max 5MB)</small>
                            </label>
                            <input type="file" id="land_ownership_doc" name="land_ownership_doc" accept=".jpg,.jpeg,.png,.pdf,.webp" required onchange="updateFileLabel(this, 'land_ownership_doc_label')">
                        </div>
                    </div>
                    
                    <div class="form-group" id="noc_field" style="display: none;">
                        <label for="noc_document">NOC from Landowner <span class="required">*</span></label>
                        <div class="file-upload-wrapper">
                            <label class="file-upload-label" for="noc_document" id="noc_document_label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Click to upload NOC</span>
                                <small>JPG, PNG, PDF (Max 5MB)</small>
                            </label>
                            <input type="file" id="noc_document" name="noc_document" accept=".jpg,.jpeg,.png,.pdf,.webp" onchange="updateFileLabel(this, 'noc_document_label')">
                        </div>
                        <small class="form-hint" style="color: var(--warning);">
                            <i class="fas fa-exclamation-triangle"></i> Required since you are a tenant
                        </small>
                    </div>
                </div>
                
                <div class="metering-info" style="margin-top: var(--space-4);">
                    <div class="info-card">
                        <i class="fas fa-shield-alt"></i>
                        <div>
                            <strong>Document Security:</strong>
                            <p style="margin-bottom: 0; font-size: 0.85rem; color: var(--text-secondary);">Your documents are securely uploaded and only accessible by authorized administrators. Accepted formats: JPG, PNG, PDF, WebP (Max 5MB each).</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-section-title">
                    <i class="fas fa-calculator"></i> Cost Estimation
                </div>
                
                <div class="cost-estimate" id="costEstimate">
                    <div class="estimate-row">
                        <span>Estimated System Cost:</span>
                        <strong id="estimatedCost">PKR 0</strong>
                    </div>
                    <div class="estimate-row">
                        <span>Estimated Annual Savings:</span>
                        <strong id="estimatedSavings">PKR 0</strong>
                    </div>
                    <div class="estimate-note">
                        <i class="fas fa-info-circle"></i> Final cost may vary based on site survey
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-large">
                        <i class="fas fa-paper-plane"></i> Submit Application
                    </button>
                    <a href="{{ url_for('client_dashboard') }}" class="btn btn-outline">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    function updateCapacityLimits() {
        const type = document.getElementById('application_type').value;
        const capacityInput = document.getElementById('system_capacity');
        const typeHint = document.getElementById('typeHint');
        const capacityHint = document.getElementById('capacityHint');
        
        if (type === 'net') {
            capacityInput.min = 5;
            typeHint.textContent = 'Net metering requires minimum 5kW system';
            typeHint.style.color = 'var(--warning)';
            capacityHint.textContent = 'Range: 5kW - 50kW';
        } else if (type === 'gross') {
            capacityInput.min = 1;
            typeHint.textContent = 'Gross metering available for 1kW - 50kW systems';
            typeHint.style.color = 'var(--success)';
            capacityHint.textContent = 'Range: 1kW - 50kW';
        } else {
            typeHint.textContent = '';
            capacityHint.textContent = 'Range: 1kW - 50kW';
        }
        
        updateCostEstimate();
    }
    
    function updateCostEstimate() {
        const capacity = parseFloat(document.getElementById('system_capacity').value) || 0;
        const costPerKw = 80000;
        
        if (capacity > 0 && capacity <= 50) {
            const totalCost = capacity * costPerKw;
            const annualSavings = capacity * 60000;
            
            document.getElementById('estimatedCost').textContent = 'PKR ' + totalCost.toLocaleString();
            document.getElementById('estimatedSavings').textContent = 'PKR ' + annualSavings.toLocaleString();
        } else {
            document.getElementById('estimatedCost').textContent = 'PKR 0';
            document.getElementById('estimatedSavings').textContent = 'PKR 0';
        }
    }
    
    function toggleNocField() {
        const ownershipType = document.getElementById('ownership_type').value;
        const nocField = document.getElementById('noc_field');
        const nocInput = document.getElementById('noc_document');
        
        if (ownershipType === 'tenant') {
            nocField.style.display = 'block';
            nocInput.required = true;
        } else {
            nocField.style.display = 'none';
            nocInput.required = false;
            nocInput.value = '';
            // Reset label
            const label = document.getElementById('noc_document_label');
            label.querySelector('span').textContent = 'Click to upload NOC';
            label.classList.remove('file-selected');
        }
    }
    
    function updateFileLabel(input, labelId) {
        const label = document.getElementById(labelId);
        if (input.files && input.files[0]) {
            const fileName = input.files[0].name;
            const fileSize = (input.files[0].size / 1024 / 1024).toFixed(2);
            
            // Check file size (5MB max)
            if (input.files[0].size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                input.value = '';
                label.querySelector('span').textContent = label.querySelector('span').dataset.originalText || 'Click to upload';
                label.classList.remove('file-selected');
                return;
            }
            
            // Save original text for reset
            if (!label.querySelector('span').dataset.originalText) {
                label.querySelector('span').dataset.originalText = label.querySelector('span').textContent;
            }
            
            label.querySelector('span').textContent = `${fileName} (${fileSize} MB)`;
            label.querySelector('i').classList.remove('fa-cloud-upload-alt');
            label.querySelector('i').classList.add('fa-check-circle');
            label.classList.add('file-selected');
        }
    }
    
    document.getElementById('system_capacity').addEventListener('input', updateCostEstimate);
    
    document.querySelector('form').addEventListener('submit', function(e) {
        const type = document.getElementById('application_type').value;
        const capacity = parseFloat(document.getElementById('system_capacity').value);
        
        if (type === 'net' && capacity < 5) {
            e.preventDefault();
            alert('Net metering requires a minimum system capacity of 5kW');
            return false;
        }
        
        if (capacity < 1 || capacity > 50) {
            e.preventDefault();
            alert('System capacity must be between 1kW and 50kW');
            return false;
        }
    });
</script>
{% endblock %}
